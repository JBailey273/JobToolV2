{% extends 'dashboard/base.html' %}
{% load humanize %}
{% block title %}Estimate - {{ estimate.estimate_number }}{% endblock %}
{% block content %}

{% if not report %}
<div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
    <div>
        <h1 class="mb-2">Customer Estimate</h1>
        <p class="text-muted mb-0">{{ estimate.estimate_number }} - {{ estimate.customer_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'dashboard:estimate_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Estimates
        </a>
        <a href="?export=pdf" class="btn btn-primary" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Download PDF
        </a>
    </div>
</div>
{% endif %}

<!-- Report Content -->
<div class="{% if report %}report-container{% else %}card{% endif %}">
    {% if not report %}
    <div class="card-body">
    {% endif %}
    
    <!-- Header Section -->
    <div class="report-header text-center mb-3">
        {% if contractor.logo %}
            <img src="{{ contractor.logo.url }}" alt="{{ contractor.name }} Logo" class="mb-2" style="max-height: 50px;">
        {% endif %}
        <h1 class="company-name">{{ contractor.name }}</h1>
        <div class="company-contact">
            {% if contractor.email %}<span>{{ contractor.email }}</span>{% endif %}
            {% if contractor.phone %}{% if contractor.email %} â€¢ {% endif %}<span>{{ contractor.phone }}</span>{% endif %}
        </div>
    </div>

    <!-- Estimate Title and Customer/Project Info Row -->
    <div class="title-section mb-3">
        <div class="row align-items-center">
            <div class="col-md-4 text-center">
                <h2 class="estimate-title">PROJECT ESTIMATE</h2>
                <p class="estimate-number">{{ estimate.estimate_number }}</p>
            </div>
            <div class="col-md-4">
                <div class="info-section">
                    <h6 class="section-title">CUSTOMER</h6>
                    <div class="info-content">
                        <p class="mb-1"><strong>{{ estimate.customer_name }}</strong></p>
                        {% if estimate.customer_email %}<p class="mb-1">{{ estimate.customer_email }}</p>{% endif %}
                        {% if estimate.customer_phone %}<p class="mb-0">{{ estimate.customer_phone }}</p>{% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-section">
                    <h6 class="section-title">PROJECT</h6>
                    <div class="info-content">
                        <p class="mb-1"><strong>{{ estimate.project_location }}</strong></p>
                        <p class="mb-1">{{ estimate.created_date|date:"M j, Y" }}</p>
                        {% if estimate.valid_until %}<p class="mb-0">Valid: {{ estimate.valid_until|date:"M j, Y" }}</p>{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if estimate.project_description %}
    <!-- Project Description -->
    <div class="mb-3">
        <h6 class="section-title">PROJECT DESCRIPTION</h6>
        <div class="description-content">
            {{ estimate.project_description|linebreaks }}
        </div>
    </div>
    {% endif %}

    <!-- Estimate Line Items -->
    <div class="mb-3">
        <h6 class="section-title">ESTIMATE BREAKDOWN</h6>
        
        <table class="estimate-table table table-bordered">
            <thead>
                <tr>
                    <th width="70%" class="text-left">Description</th>
                    <th width="30%" class="text-right">Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- Labor & Equipment (Combined) -->
                {% if labor_equipment_total > 0 %}
                <tr>
                    <td class="text-left">
                        <strong>Labor & Equipment</strong>
                        <div class="item-details">Professional labor and equipment services</div>
                    </td>
                    <td class="text-right amount">${{ labor_equipment_total|floatformat:2|intcomma }}</td>
                </tr>
                {% endif %}

                <!-- Materials (Line by Line) -->
                {% for material in material_entries %}
                <tr>
                    <td class="text-left">
                        <strong>{{ material.material_description }}</strong>
                        {% if material.description and "Material:" in material.description %}
                        <div class="item-details">{{ material.description|slice:"10:" }}</div>
                        {% endif %}
                    </td>
                    <td class="text-right amount">${{ material.billable_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}

                <!-- Outside Services (Line by Line) -->
                {% for service in service_entries %}
                <tr>
                    <td class="text-left">
                        <strong>{{ service.material_description }}</strong>
                        {% if service.description and "Outside Service:" in service.description %}
                        <div class="item-details">{{ service.description|slice:"17:" }}</div>
                        {% endif %}
                    </td>
                    <td class="text-right amount">${{ service.billable_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td class="text-left"><strong>TOTAL ESTIMATE</strong></td>
                    <td class="text-right total-amount">${{ grand_total|floatformat:2|intcomma }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Terms and Signature Section Side by Side -->
    <div class="row mb-2">
        <div class="col-md-8">
            <div class="terms-section">
                <h6 class="section-title">TERMS & CONDITIONS</h6>
                
                {% if estimate.payment_terms %}
                <div class="terms-item">
                    <span class="terms-subtitle">Payment:</span> {{ estimate.payment_terms|truncatewords:15 }}
                </div>
                {% endif %}

                {% if estimate.exclusions %}
                <div class="terms-item">
                    <span class="terms-subtitle">Exclusions:</span> {{ estimate.exclusions|truncatewords:15 }}
                </div>
                {% endif %}

                {% if estimate.special_terms %}
                <div class="terms-item">
                    <span class="terms-subtitle">Special Terms:</span> {{ estimate.special_terms|truncatewords:15 }}
                </div>
                {% endif %}

                <div class="terms-item">
                    <span class="terms-subtitle">General:</span> 
                    This estimate is valid for the period specified. Prices may vary based on material costs. 
                    Changes to scope may affect final price. Work performed to standard practices.
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="signature-section">
                <h6 class="section-title">ACCEPTANCE</h6>
                <p class="signature-text">I accept this estimate and authorize {{ contractor.name }} to proceed.</p>
                
                <div class="signature-fields">
                    <div class="signature-line">
                        <div class="signature-box"></div>
                        <span class="signature-label">Customer Signature</span>
                    </div>
                    <div class="signature-line">
                        <div class="signature-box"></div>
                        <span class="signature-label">Date</span>
                    </div>
                    <div class="signature-line">
                        <div class="signature-box"></div>
                        <span class="signature-label">Print Name</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="report-footer text-center">
        <small class="text-muted">Thank you for considering {{ contractor.name }} for your project needs.</small>
    </div>

    {% if not report %}
    </div>
    {% endif %}
</div>

<style>
/* Modern font family */
* {
    font-family: 'Inter', 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Global spacing reductions */
.report-container, .card-body {
    padding: 20px !important;
}

/* Header section - more compact */
.report-header {
    margin-bottom: 15px !important;
}

.company-name {
    font-size: 1.8rem;
    font-weight: 700;
    color: #2d5016;
    margin-bottom: 5px;
    letter-spacing: -0.5px;
}

.company-contact {
    color: #4a7c2a;
    font-size: 0.9rem;
    font-weight: 500;
}

/* Title section - horizontal layout */
.title-section .estimate-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2d5016;
    margin-bottom: 3px;
    letter-spacing: 0.5px;
}

.title-section .estimate-number {
    font-size: 1rem;
    color: #4a7c2a;
    font-weight: 600;
    margin-bottom: 0;
}

/* Compact info sections */
.info-section {
    background: #f8faf6;
    border: 1px solid #d4d4aa;
    border-radius: 6px;
    padding: 12px;
    height: 100%;
}

.section-title {
    color: #2d5016;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
    border-bottom: 1px solid #4a7c2a;
    padding-bottom: 3px;
    margin-bottom: 8px;
}

.info-content {
    color: #333;
    font-size: 0.85rem;
    line-height: 1.3;
}

.info-content p {
    margin-bottom: 3px !important;
}

/* Project description - compact */
.description-content {
    background: #f8faf6;
    border: 1px solid #d4d4aa;
    border-radius: 6px;
    padding: 12px;
    color: #333;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* Estimate table - more compact */
.estimate-table {
    border: 2px solid #2d5016;
    margin-bottom: 0;
    font-size: 0.9rem;
}

.estimate-table th {
    background: #4a7c2a !important;
    color: white !important;
    border: 1px solid #2d5016;
    padding: 8px 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-size: 0.8rem;
}

.estimate-table td {
    padding: 8px 10px;
    border: 1px solid #d4d4aa;
    vertical-align: top;
    line-height: 1.3;
}

.estimate-table tbody tr:nth-child(even) {
    background-color: #f8faf6;
}

.estimate-table .item-details {
    font-size: 0.8rem;
    color: #666;
    margin-top: 2px;
    font-style: italic;
    line-height: 1.2;
}

.estimate-table .total-row {
    background: #e8f0de !important;
    border-top: 3px solid #2d5016;
}

.estimate-table .total-row td {
    padding: 10px;
    font-size: 1rem;
    font-weight: 700;
    color: #2d5016;
}

.estimate-table .total-amount {
    font-size: 1.2rem !important;
    color: #2d5016 !important;
}

/* Compact terms section */
.terms-section {
    background: #f8faf6;
    border: 1px solid #d4d4aa;
    border-radius: 6px;
    padding: 12px;
    height: 100%;
}

.terms-item {
    margin-bottom: 8px;
    font-size: 0.8rem;
    line-height: 1.3;
}

.terms-item:last-child {
    margin-bottom: 0;
}

.terms-subtitle {
    color: #4a7c2a;
    font-weight: 700;
}

/* Compact signature section */
.signature-section {
    background: #f8faf6;
    border: 1px solid #4a7c2a;
    border-radius: 6px;
    padding: 12px;
    height: 100%;
}

.signature-text {
    font-size: 0.8rem;
    margin-bottom: 10px;
    line-height: 1.3;
}

.signature-fields {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.signature-line {
    display: flex;
    align-items: center;
    gap: 8px;
}

.signature-box {
    border-bottom: 1px solid #2d5016;
    height: 20px;
    flex: 1;
    min-width: 80px;
}

.signature-label {
    font-weight: 600;
    color: #2d5016;
    font-size: 0.7rem;
    white-space: nowrap;
    min-width: 60px;
}

.amount {
    font-family: 'SF Mono', 'Monaco', 'Roboto Mono', monospace;
    font-weight: 600;
}

/* Footer */
.report-footer {
    margin-top: 10px !important;
}

.report-footer small {
    font-size: 0.75rem;
}

/* PDF-specific styles for single page */
@media print {
    @page {
        margin: 0.5in;
        size: letter;
    }
    
    body {
        font-size: 11px !important;
        line-height: 1.2 !important;
    }
    
    .report-container, .card-body {
        padding: 0 !important;
        margin: 0 !important;
    }
    
    .mb-3 {
        margin-bottom: 8px !important;
    }
    
    .mb-2 {
        margin-bottom: 6px !important;
    }
    
    .estimate-table {
        border-collapse: collapse;
        width: 100%;
        font-size: 10px;
    }
    
    .estimate-table th,
    .estimate-table td {
        border: 1px solid #333 !important;
        padding: 4px 6px !important;
    }
    
    .estimate-table th {
        background: #e8f0de !important;
        color: #000 !important;
    }
    
    .estimate-table .total-row {
        background: #e8f0de !important;
        border-top: 2px solid #000 !important;
    }
    
    .estimate-table .total-row td {
        padding: 6px !important;
        font-size: 11px !important;
    }
    
    .company-name,
    .estimate-title,
    .section-title {
        color: #000 !important;
    }
    
    .info-section,
    .description-content,
    .terms-section,
    .signature-section {
        background: #f5f5f5 !important;
        border: 1px solid #333 !important;
    }
    
    .signature-box {
        border-bottom: 1px solid #000 !important;
        height: 15px !important;
    }
    
    .terms-item,
    .signature-text {
        font-size: 9px !important;
    }
    
    .info-content {
        font-size: 9px !important;
    }
    
    .section-title {
        font-size: 9px !important;
        margin-bottom: 4px !important;
    }
    
    .company-name {
        font-size: 16px !important;
        margin-bottom: 2px !important;
    }
    
    .estimate-title {
        font-size: 14px !important;
        margin-bottom: 2px !important;
    }
    
    .estimate-number {
        font-size: 10px !important;
    }
    
    /* Force single page */
    .report-container {
        page-break-inside: avoid;
        max-height: 10in;
        overflow: hidden;
    }
}

@media (max-width: 768px) {
    .company-name {
        font-size: 1.4rem;
    }
    
    .estimate-title {
        font-size: 1.2rem;
    }
    
    .estimate-table th,
    .estimate-table td {
        padding: 6px;
        font-size: 0.8rem;
    }
    
    .signature-section {
        margin-top: 15px;
    }
    
    .signature-fields {
        gap: 10px;
    }
}
</style>

{% endblock %}
