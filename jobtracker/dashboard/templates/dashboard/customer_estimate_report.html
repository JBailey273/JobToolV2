{% extends 'dashboard/base.html' %}
{% load humanize %}
{% block title %}Estimate - {{ estimate.estimate_number }}{% endblock %}
{% block content %}

{% if not report %}
<div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
    <div>
        <h1 class="mb-2">Customer Estimate</h1>
        <p class="text-muted mb-0">{{ estimate.estimate_number }} - {{ estimate.customer_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'dashboard:estimate_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Estimates
        </a>
        <a href="?export=pdf" class="btn btn-primary" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Download PDF
        </a>
    </div>
</div>
{% endif %}

<!-- Report Content -->
<div class="{% if report %}report-container{% else %}card{% endif %}">
    {% if not report %}
    <div class="card-body">
    {% endif %}
    
    <!-- Header Section -->
    <div class="report-header text-center mb-4">
        {% if contractor.logo %}
            <img src="{{ contractor.logo.url }}" alt="{{ contractor.name }} Logo" class="mb-3" style="max-height: 80px;">
        {% endif %}
        <h1 class="company-name">{{ contractor.name }}</h1>
        <div class="company-contact">
            {% if contractor.email %}<p class="mb-1">{{ contractor.email }}</p>{% endif %}
            {% if contractor.phone %}<p class="mb-0">{{ contractor.phone }}</p>{% endif %}
        </div>
    </div>

    <!-- Estimate Title -->
    <div class="text-center mb-4">
        <h2 class="estimate-title">PROJECT ESTIMATE</h2>
        <p class="estimate-number">{{ estimate.estimate_number }}</p>
    </div>

    <!-- Customer and Project Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="info-section">
                <h6 class="section-title">CUSTOMER INFORMATION</h6>
                <div class="info-content">
                    <p class="mb-1"><strong>{{ estimate.customer_name }}</strong></p>
                    {% if estimate.customer_email %}<p class="mb-1">{{ estimate.customer_email }}</p>{% endif %}
                    {% if estimate.customer_phone %}<p class="mb-1">{{ estimate.customer_phone }}</p>{% endif %}
                    {% if estimate.customer_address %}
                        <div class="mt-2">
                            {{ estimate.customer_address|linebreaks }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="info-section">
                <h6 class="section-title">PROJECT DETAILS</h6>
                <div class="info-content">
                    <p class="mb-1"><strong>Location:</strong></p>
                    <p class="mb-2">{{ estimate.project_location }}</p>
                    <p class="mb-1"><strong>Date:</strong> {{ estimate.created_date|date:"F j, Y" }}</p>
                    {% if estimate.valid_until %}
                    <p class="mb-1"><strong>Valid Until:</strong> {{ estimate.valid_until|date:"F j, Y" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if estimate.project_description %}
    <!-- Project Description -->
    <div class="mb-4">
        <h6 class="section-title">PROJECT DESCRIPTION</h6>
        <div class="description-content">
            {{ estimate.project_description|linebreaks }}
        </div>
    </div>
    {% endif %}

    <!-- Estimate Line Items -->
    <div class="mb-4">
        <h6 class="section-title">ESTIMATE BREAKDOWN</h6>
        
        <table class="estimate-table table table-bordered">
            <thead>
                <tr>
                    <th width="70%" class="text-left">Description</th>
                    <th width="30%" class="text-right">Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- Labor & Equipment (Combined) -->
                {% if labor_equipment_total > 0 %}
                <tr>
                    <td class="text-left">
                        <strong>Labor & Equipment</strong>
                        <div class="item-details">
                            Professional labor and equipment services for project completion
                        </div>
                    </td>
                    <td class="text-right amount">${{ labor_equipment_total|floatformat:2|intcomma }}</td>
                </tr>
                {% endif %}

                <!-- Materials (Line by Line) -->
                {% for material in material_entries %}
                <tr>
                    <td class="text-left">
                        <strong>{{ material.material_description }}</strong>
                        {% if material.description and "Material:" in material.description %}
                        <div class="item-details">
                            {{ material.description|slice:"10:" }}
                        </div>
                        {% endif %}
                    </td>
                    <td class="text-right amount">${{ material.billable_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}

                <!-- Outside Services (Line by Line) -->
                {% for service in service_entries %}
                <tr>
                    <td class="text-left">
                        <strong>{{ service.material_description }}</strong>
                        {% if service.description and "Outside Service:" in service.description %}
                        <div class="item-details">
                            {{ service.description|slice:"17:" }}
                        </div>
                        {% endif %}
                    </td>
                    <td class="text-right amount">${{ service.billable_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td class="text-left"><strong>TOTAL ESTIMATE</strong></td>
                    <td class="text-right total-amount">${{ grand_total|floatformat:2|intcomma }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Terms and Conditions -->
    <div class="terms-section mb-4">
        <h6 class="section-title">TERMS & CONDITIONS</h6>
        
        {% if estimate.payment_terms %}
        <div class="terms-item">
            <h6 class="terms-subtitle">Payment Terms</h6>
            <p>{{ estimate.payment_terms|linebreaks }}</p>
        </div>
        {% endif %}

        {% if estimate.exclusions %}
        <div class="terms-item">
            <h6 class="terms-subtitle">Exclusions</h6>
            <p>{{ estimate.exclusions|linebreaks }}</p>
        </div>
        {% endif %}

        {% if estimate.special_terms %}
        <div class="terms-item">
            <h6 class="terms-subtitle">Special Terms</h6>
            <p>{{ estimate.special_terms|linebreaks }}</p>
        </div>
        {% endif %}

        {% if estimate.liability_statement %}
        <div class="terms-item">
            <h6 class="terms-subtitle">Liability & Insurance</h6>
            <p>{{ estimate.liability_statement|linebreaks }}</p>
        </div>
        {% endif %}

        <div class="terms-item">
            <h6 class="terms-subtitle">General Terms</h6>
            <ul class="small">
                <li>This estimate is valid for the period specified above</li>
                <li>Prices may vary based on material costs and availability</li>
                <li>Any changes to the scope of work may affect the final price</li>
                <li>Work to be performed in a professional manner according to standard practices</li>
            </ul>
        </div>
    </div>

    <!-- Signature Section -->
    <div class="signature-section">
        <h6 class="section-title">ACCEPTANCE</h6>
        <div class="signature-content">
            <p>I hereby accept the above estimate and authorize {{ contractor.name }} to proceed with the work as described.</p>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="signature-line">
                        <div class="signature-box"></div>
                        <p class="signature-label">Customer Signature</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="signature-line">
                        <div class="signature-box"></div>
                        <p class="signature-label">Date</p>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="signature-line">
                        <div class="signature-box"></div>
                        <p class="signature-label">Print Name</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="report-footer mt-4 text-center">
        <small class="text-muted">
            Thank you for considering {{ contractor.name }} for your project needs.
        </small>
    </div>

    {% if not report %}
    </div>
    {% endif %}
</div>

<style>
/* Customer Estimate Specific Styles */
.estimate-table {
    border: 2px solid #2d5016;
    margin-bottom: 0;
}

.estimate-table th {
    background: #4a7c2a !important;
    color: white !important;
    border: 1px solid #2d5016;
    padding: 12px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.estimate-table td {
    padding: 12px;
    border: 1px solid #d4d4aa;
    vertical-align: top;
}

.estimate-table tbody tr:nth-child(even) {
    background-color: #f8faf6;
}

.estimate-table .item-details {
    font-size: 0.9em;
    color: #666;
    margin-top: 4px;
    font-style: italic;
}

.estimate-table .total-row {
    background: #e8f0de !important;
    border-top: 3px solid #2d5016;
}

.estimate-table .total-row td {
    padding: 16px 12px;
    font-size: 1.1em;
    font-weight: bold;
    color: #2d5016;
}

.estimate-table .total-amount {
    font-size: 1.3em !important;
    color: #2d5016 !important;
}

.company-name {
    font-size: 2rem;
    font-weight: bold;
    color: #2d5016;
    margin-bottom: 10px;
}

.company-contact {
    color: #4a7c2a;
    font-size: 1rem;
}

.estimate-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2d5016;
    margin-bottom: 5px;
    letter-spacing: 1px;
}

.estimate-number {
    font-size: 1.2rem;
    color: #4a7c2a;
    font-weight: 600;
    margin-bottom: 0;
}

.info-section {
    background: #f8faf6;
    border: 1px solid #d4d4aa;
    border-radius: 8px;
    padding: 20px;
    height: 100%;
}

.section-title {
    color: #2d5016;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #4a7c2a;
    padding-bottom: 5px;
    margin-bottom: 15px;
}

.info-content {
    color: #333;
}

.description-content {
    background: #f8faf6;
    border: 1px solid #d4d4aa;
    border-radius: 8px;
    padding: 20px;
    color: #333;
}

.terms-section {
    background: #f8faf6;
    border: 1px solid #d4d4aa;
    border-radius: 8px;
    padding: 20px;
}

.terms-item {
    margin-bottom: 20px;
}

.terms-item:last-child {
    margin-bottom: 0;
}

.terms-subtitle {
    color: #4a7c2a;
    font-weight: bold;
    margin-bottom: 8px;
}

.signature-section {
    background: #f8faf6;
    border: 2px solid #4a7c2a;
    border-radius: 8px;
    padding: 30px;
    margin-top: 30px;
}

.signature-line {
    text-align: center;
}

.signature-box {
    border-bottom: 2px solid #2d5016;
    height: 40px;
    margin-bottom: 8px;
}

.signature-label {
    font-weight: bold;
    color: #2d5016;
    margin-bottom: 0;
    font-size: 0.9rem;
}

.amount {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

/* PDF-specific styles */
@media print {
    .estimate-table {
        border-collapse: collapse;
        width: 100%;
        page-break-inside: avoid;
    }
    
    .estimate-table th,
    .estimate-table td {
        border: 1px solid #333 !important;
        padding: 8px !important;
    }
    
    .estimate-table th {
        background: #e8f0de !important;
        color: #000 !important;
    }
    
    .estimate-table .total-row {
        background: #e8f0de !important;
        border-top: 2px solid #000 !important;
    }
    
    .company-name,
    .estimate-title,
    .section-title {
        color: #000 !important;
    }
    
    .info-section,
    .description-content,
    .terms-section,
    .signature-section {
        background: #f5f5f5 !important;
        border: 1px solid #333 !important;
    }
    
    .signature-box {
        border-bottom: 2px solid #000 !important;
    }
}

@media (max-width: 768px) {
    .company-name {
        font-size: 1.5rem;
    }
    
    .estimate-title {
        font-size: 1.4rem;
    }
    
    .estimate-number {
        font-size: 1rem;
    }
    
    .estimate-table th,
    .estimate-table td {
        padding: 8px;
        font-size: 0.9rem;
    }
    
    .signature-section {
        padding: 20px;
    }
}
</style>

{% endblock %}
