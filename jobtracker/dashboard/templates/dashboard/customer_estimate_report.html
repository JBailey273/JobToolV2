{% extends 'dashboard/base.html' %}
{% load humanize estimate_extras %}
{% block title %}Estimate - {{ estimate.estimate_number }}{% endblock %}
{% block content %}

{% if not report %}
<div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
    <div>
        <h1 class="mb-2">Customer Estimate</h1>
        <p class="text-muted mb-0">{{ estimate.estimate_number }} - {{ estimate.customer_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'dashboard:estimate_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Estimates
        </a>
        <a href="?export=pdf" class="btn btn-primary" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>Download PDF
        </a>
    </div>
</div>
{% endif %}

<!-- Report Content -->
<div class="{% if report %}report-container{% else %}card{% endif %}">
    {% if not report %}
    <div class="card-body">
    {% endif %}
    
    <!-- Header Section -->
    <div class="estimate-header">
        <div class="header-left">
            {% if contractor_logo %}
                <img src="{{ contractor_logo }}" alt="{{ contractor.name }} Logo" class="company-logo">
            {% endif %}
            <div class="company-info">
                <h1 class="company-name">{{ contractor.name }}</h1>
                <div class="company-contact">
                    {% if contractor.email %}{{ contractor.email }}{% endif %}
                    {% if contractor.phone %}{% if contractor.email %} â€¢ {% endif %}{{ contractor.phone }}{% endif %}
                </div>
            </div>
        </div>
        <div class="header-right">
            <h2 class="estimate-title">ESTIMATE</h2>
            <div class="estimate-number">{{ estimate.estimate_number }}</div>
        </div>
    </div>

    <!-- Customer and Project Info -->
    <div class="info-section">
        <div class="customer-info">
            <h3 class="info-title">Bill To:</h3>
            <div class="info-content">
                <div class="customer-name">{{ estimate.customer_name }}</div>
                {% if estimate.customer_email %}<div>{{ estimate.customer_email }}</div>{% endif %}
                {% if estimate.customer_phone %}<div>{{ estimate.customer_phone }}</div>{% endif %}
            </div>
        </div>
        <div class="project-info">
            <h3 class="info-title">Project:</h3>
            <div class="info-content">
                <div class="project-location">{{ estimate.project_location }}</div>
                <div class="project-date">Date: {{ estimate.created_date|date:"M j, Y" }}</div>
                {% if estimate.valid_until %}<div class="valid-until">Valid Until: {{ estimate.valid_until|date:"M j, Y" }}</div>{% endif %}
            </div>
        </div>
    </div>

    {% if estimate.project_description %}
    <!-- Project Description -->
    <div class="description-section">
        <h3 class="section-title">Project Description</h3>
        <div class="description-text">{{ estimate.project_description|linebreaks }}</div>
    </div>
    {% endif %}

    <!-- Line Items Table -->
    <div class="items-section">
        <table class="items-table">
            <thead>
                <tr>
                    <th class="description-col">Description</th>
                    <th class="amount-col">Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- Labor & Equipment (Combined) -->
                {% if labor_equipment_total > 0 %}
                <tr>
                    <td class="item-description">
                        <div class="main-desc">Labor & Equipment</div>
                        <div class="sub-desc">Professional labor and equipment services</div>
                    </td>
                    <td class="item-amount">${{ labor_equipment_total|floatformat:2|intcomma }}</td>
                </tr>
                {% endif %}

                <!-- Materials (Line by Line) -->
                {% for material in material_entries %}
                <tr>
                    <td class="item-description">
                        {% with main=material.material_description|dedupe_qty sub=material.description|slice:"10:"|dedupe_qty %}
                        <div class="main-desc">{{ main }}</div>
                        {% if material.description and "Material:" in material.description and sub != main %}
                        <div class="sub-desc">{{ sub }}</div>
                        {% endif %}
                        {% endwith %}
                    </td>
                    <td class="item-amount">${{ material.billable_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}

                <!-- Outside Services (Line by Line) -->
                {% for service in service_entries %}
                <tr>
                    <td class="item-description">
                        {% with main=service.material_description|dedupe_qty sub=service.description|slice:"17:"|dedupe_qty %}
                        <div class="main-desc">{{ main }}</div>
                        {% if service.description and "Outside Service:" in service.description and sub != main %}
                        <div class="sub-desc">{{ sub }}</div>
                        {% endif %}
                        {% endwith %}
                    </td>
                    <td class="item-amount">${{ service.billable_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Total -->
        <div class="total-section">
            <div class="total-row">
                <span class="total-label">Total:</span>
                <span class="total-amount">${{ grand_total|floatformat:2|intcomma }}</span>
            </div>
        </div>
    </div>

    <!-- Terms and Acceptance -->
    <div class="bottom-section">
        <div class="terms-column">
            <h3 class="section-title">Terms & Conditions</h3>
            
            {% if estimate.payment_terms %}
            <div class="terms-item">
                <strong>Payment:</strong> {{ estimate.payment_terms }}
            </div>
            {% endif %}

            {% if estimate.exclusions %}
            <div class="terms-item">
                <strong>Exclusions:</strong> {{ estimate.exclusions }}
            </div>
            {% endif %}

            {% if estimate.special_terms %}
            <div class="terms-item">
                <strong>Special Terms:</strong> {{ estimate.special_terms }}
            </div>
            {% endif %}

            <div class="terms-item">
                <strong>General:</strong> This estimate is valid for the period specified. Prices may vary based on material costs. Changes to scope may affect final price. Work performed to standard practices.
            </div>
        </div>

        <div class="acceptance-column">
            <h3 class="section-title">Acceptance</h3>
            <div class="acceptance-text">
                I accept this estimate and authorize {{ contractor.name }} to proceed.
            </div>
            
            <div class="signature-fields">
                <div class="signature-field">
                    <div class="signature-line"></div>
                    <div class="signature-label">Customer Signature</div>
                </div>
                <div class="signature-field">
                    <div class="signature-line"></div>
                    <div class="signature-label">Date</div>
                </div>
                <div class="signature-field">
                    <div class="signature-line"></div>
                    <div class="signature-label">Print Name</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-text">
        Thank you for considering {{ contractor.name }} for your project needs.
    </div>

    {% if not report %}
    </div>
    {% endif %}
</div>

<style>
/* Reset and base styles */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Arial', sans-serif;
    line-height: 1.4;
    color: #333;
}

/* Screen styles (non-print) */
.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
    border-radius: 8px;
}

.card-body {
    padding: 40px;
}

/* Print-specific styles */
@media print {
    @page {
        margin: 0.5in;
        size: letter;
    }
    
    body {
        font-size: 11pt;
        line-height: 1.3;
        color: #000;
        -webkit-print-color-adjust: exact;
    }
    
    .report-container {
        padding: 0;
        margin: 0;
        width: 100%;
        max-width: none;
    }
    
    /* Hide screen elements */
    .d-print-none {
        display: none !important;
    }
}

/* Header Section */
.estimate-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #333;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.company-logo {
    max-height: 60px;
    max-width: 120px;
}

.company-name {
    font-size: 24pt;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.company-contact {
    font-size: 10pt;
    color: #666;
}

.header-right {
    text-align: right;
}

.estimate-title {
    font-size: 28pt;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.estimate-number {
    font-size: 14pt;
    color: #666;
    font-weight: bold;
}

/* Info Section */
.info-section {
    display: flex;
    justify-content: space-between;
    margin-bottom: 25px;
    gap: 40px;
}

.customer-info,
.project-info {
    flex: 1;
}

.info-title {
    font-size: 12pt;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-content {
    font-size: 10pt;
    line-height: 1.4;
}

.customer-name,
.project-location {
    font-weight: bold;
    margin-bottom: 3px;
}

/* Description Section */
.description-section {
    margin-bottom: 25px;
}

.section-title {
    font-size: 12pt;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 3px;
}

.description-text {
    font-size: 10pt;
    padding: 10px;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 3px;
}

/* Items Table */
.items-section {
    margin-bottom: 25px;
}

.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0;
}

.items-table th {
    background-color: #333;
    color: white;
    padding: 12px;
    text-align: left;
    font-size: 10pt;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.description-col {
    width: 70%;
}

.amount-col {
    width: 30%;
    text-align: right;
}

.items-table td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
    vertical-align: top;
}

.items-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}

.item-description .main-desc {
    font-weight: bold;
    font-size: 10pt;
    margin-bottom: 2px;
}

.item-description .sub-desc {
    font-size: 9pt;
    color: #666;
    font-style: italic;
}

.item-amount {
    text-align: right;
    font-size: 10pt;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

/* Total Section */
.total-section {
    margin-top: 10px;
}

.total-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 15px 12px;
    background-color: #f0f0f0;
    border: 2px solid #333;
    border-radius: 3px;
}

.total-label {
    font-size: 14pt;
    font-weight: bold;
    margin-right: 20px;
}

.total-amount {
    font-size: 16pt;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    color: #333;
}

/* Bottom Section */
.bottom-section {
    display: flex;
    gap: 30px;
    margin-bottom: 25px;
}

.terms-column {
    flex: 2;
}

.acceptance-column {
    flex: 1;
}

.terms-item {
    margin-bottom: 8px;
    font-size: 9pt;
    line-height: 1.3;
}

.terms-item strong {
    color: #333;
}

.acceptance-text {
    font-size: 9pt;
    margin-bottom: 20px;
    line-height: 1.3;
}

.signature-fields {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.signature-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.signature-line {
    border-bottom: 1px solid #333;
    height: 25px;
    width: 100%;
}

.signature-label {
    font-size: 8pt;
    color: #666;
    text-align: center;
}

/* Footer */
.footer-text {
    text-align: center;
    font-size: 9pt;
    color: #666;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
}

/* Print optimizations */
@media print {
    .company-logo {
        max-height: 50px;
        max-width: 100px;
    }
    
    .company-name {
        font-size: 20pt;
    }
    
    .estimate-title {
        font-size: 24pt;
    }
    
    .estimate-number {
        font-size: 12pt;
    }
    
    .info-title {
        font-size: 10pt;
    }
    
    .section-title {
        font-size: 10pt;
    }
    
    .total-label {
        font-size: 12pt;
    }
    
    .total-amount {
        font-size: 14pt;
    }
    
    /* Ensure proper page breaks */
    .estimate-header {
        page-break-inside: avoid;
    }
    
    .items-table {
        page-break-inside: avoid;
    }
    
    .bottom-section {
        page-break-inside: avoid;
    }
    
    /* Remove background colors for better printing */
    .items-table tbody tr:nth-child(even) {
        background-color: transparent;
    }
    
    .total-row {
        background-color: #f5f5f5;
    }
    
    .description-text {
        background-color: #f5f5f5;
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .estimate-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .header-left {
        flex-direction: column;
        text-align: center;
    }
    
    .header-right {
        text-align: center;
    }
    
    .info-section {
        flex-direction: column;
        gap: 20px;
    }
    
    .bottom-section {
        flex-direction: column;
        gap: 20px;
    }
    
    .items-table {
        font-size: 9pt;
    }
    
    .items-table th,
    .items-table td {
        padding: 8px;
    }
}
</style>

{% endblock %}
