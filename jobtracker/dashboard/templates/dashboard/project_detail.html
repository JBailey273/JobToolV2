{% extends 'dashboard/base.html' %}
{% load humanize %}
{% block title %}{{ project.name }}{% endblock %}
{% block extra_css %}
<style>
/* Enhanced Analytics Tab Styles */

/* Analytics Header */
.analytics-header {
    background: linear-gradient(135deg, #f8faf6 0%, #e8f0de 100%);
    padding: 25px;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    margin-bottom: 0;
}

.analytics-summary {
    background: rgba(255, 255, 255, 0.8);
    border-radius: var(--radius-md);
    padding: 15px 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

/* KPI Cards */
.kpi-card {
    background: var(--card-background);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-md);
    border: none;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    align-items: center;
    gap: 15px;
}

.kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.kpi-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    flex-shrink: 0;
}

.kpi-icon.bg-primary { background: var(--primary-gradient); }
.kpi-icon.bg-warning { background: var(--warning-gradient); }
.kpi-icon.bg-success { background: var(--success-gradient); }
.kpi-icon.bg-info { background: var(--info-gradient); }

.kpi-content {
    flex-grow: 1;
}

.kpi-value {
    font-size: 1.75rem;
    font-weight: 800;
    margin-bottom: 2px;
    color: var(--text-primary);
}

.kpi-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 4px;
}

.kpi-change {
    font-size: 0.8rem;
    font-weight: 500;
}

/* Analytics Section Cards */
.analytics-section-card {
    background: var(--card-background);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: 30px;
    border: none;
}

.section-header {
    text-align: center;
    margin-bottom: 30px;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.section-subtitle {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin: 0;
}

/* Category Analysis */
.category-analysis-row {
    background: #f9f9f9;
    border-radius: var(--radius-lg);
    padding: 25px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.category-analysis-row:hover {
    background: #f5f5f5;
    border-color: var(--primary-color);
    transform: translateY(-1px);
}

.category-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

@media (min-width: 768px) {
    .category-header {
        margin-bottom: 0;
    }
}

.category-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    flex-shrink: 0;
}

.category-icon.bg-primary { background: var(--primary-gradient); }
.category-icon.bg-warning { background: var(--warning-gradient); }
.category-icon.bg-secondary { background: var(--secondary-gradient); }

.category-info h6 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.category-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0;
}

/* Category Metrics */
.category-metrics {
    background: white;
    border-radius: var(--radius-md);
    padding: 20px;
    border: 1px solid #e9ecef;
}

.metric-box {
    text-align: center;
    padding: 10px 5px;
}

.metric-value {
    font-size: 1.4rem;
    font-weight: 800;
    margin-bottom: 3px;
}

.metric-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* Progress Comparison */
.progress-comparison {
    margin-top: 15px;
}

.progress-comparison .progress {
    background: #e9ecef;
    border-radius: 4px;
    overflow: visible;
    position: relative;
}

.progress-comparison .progress-bar.bg-danger {
    background: linear-gradient(90deg, #dc3545, #c82333) !important;
}

.progress-comparison .progress-bar.bg-success {
    background: linear-gradient(90deg, #28a745, #218838) !important;
    margin-left: 2px;
}

.progress-labels {
    font-size: 0.75rem;
}

/* Business Insights Card */
.insights-card {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-radius: var(--radius-lg);
    padding: 25px;
    border: none;
    box-shadow: var(--shadow-md);
    height: 100%;
}

.insights-header {
    margin-bottom: 20px;
}

.insights-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #856404;
    margin: 0;
}

.insight-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.6);
    border-radius: var(--radius-md);
    backdrop-filter: blur(5px);
}

.insight-item:last-child {
    margin-bottom: 0;
}

.insight-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    flex-shrink: 0;
    font-size: 14px;
}

.insight-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: #6c4b00;
}

/* Recommendations Card */
.recommendations-card {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-radius: var(--radius-lg);
    padding: 25px;
    border: none;
    box-shadow: var(--shadow-md);
    height: 100%;
}

.recommendations-header {
    margin-bottom: 20px;
}

.recommendations-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #0c5460;
    margin: 0;
}

.recommendation-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--radius-md);
    backdrop-filter: blur(5px);
}

.recommendation-item:last-child {
    margin-bottom: 0;
}

.rec-priority {
    width: 6px;
    height: 35px;
    border-radius: 3px;
    flex-shrink: 0;
    margin-top: 2px;
}

.rec-priority.high {
    background: linear-gradient(180deg, #dc3545, #c82333);
}

.rec-priority.medium {
    background: linear-gradient(180deg, #ffc107, #e0a800);
}

.rec-priority.low {
    background: linear-gradient(180deg, #28a745, #218838);
}

.rec-text {
    font-size: 0.9rem;
    line-height: 1.4;
    color: #0c5460;
}

/* Trends Card */
.trends-card {
    background: var(--card-background);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: 30px;
    border: none;
}

.trends-header {
    text-align: center;
}

.trends-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.trends-subtitle {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin: 0;
}

/* Weekly Trends Chart */
.trends-chart {
    background: #f8f9fa;
    border-radius: var(--radius-lg);
    padding: 25px 15px;
    margin-top: 20px;
}

.week-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 5px;
}

.week-bars {
    height: 120px;
    display: flex;
    align-items: flex-end;
    margin-bottom: 15px;
    overflow: hidden;
}

.bar-container {
    display: flex;
    align-items: end;
    gap: 3px;
    height: 100%;
}

.revenue-bar,
.cost-bar {
    width: 18px;
    border-radius: 3px 3px 0 0;
    min-height: 8px;
    position: relative;
    transition: all 0.3s ease;
}

.revenue-bar {
    background: linear-gradient(180deg, #28a745, #20c997);
    box-shadow: 0 -2px 8px rgba(40, 167, 69, 0.3);
}

.cost-bar {
    background: linear-gradient(180deg, #dc3545, #fd7e14);
    box-shadow: 0 -2px 8px rgba(220, 53, 69, 0.3);
}

.revenue-bar:hover,
.cost-bar:hover {
    transform: scaleY(1.05);
    filter: brightness(1.1);
}

.week-label {
    text-align: center;
    min-height: 60px;
}

.week-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 3px;
}

.week-values {
    display: flex;
    flex-direction: column;
    gap: 1px;
    margin-bottom: 3px;
}

.week-hours {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 500;
}

/* Chart Legend */
.chart-legend {
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
}

.legend-color.revenue {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.legend-color.cost {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
}

/* Responsive Design for Analytics */
@media (max-width: 768px) {
    .analytics-header {
        padding: 20px;
    }
    
    .analytics-summary {
        margin-top: 15px;
    }
    
    .kpi-card {
        padding: 15px;
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .kpi-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .kpi-value {
        font-size: 1.5rem;
    }
    
    .analytics-section-card {
        padding: 20px;
    }
    
    .category-analysis-row {
        padding: 20px 15px;
    }
    
    .category-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .category-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
    
    .metric-box {
        margin-bottom: 15px;
    }
    
    .metric-value {
        font-size: 1.2rem;
    }
    
    .week-column {
        padding: 0 2px;
    }
    
    .revenue-bar,
    .cost-bar {
        width: 12px;
    }
    
    .week-name {
        font-size: 0.7rem;
    }
    
    .week-values small {
        font-size: 0.7rem;
    }
    
    .trends-card {
        padding: 20px;
    }
    
    .insights-card,
    .recommendations-card {
        padding: 20px;
        margin-bottom: 20px;
    }
}

@media (max-width: 576px) {
    .week-bars {
        height: 80px;
    }
    
    .revenue-bar,
    .cost-bar {
        width: 8px;
    }
    
    .week-values {
        display: none;
    }
    
    .metric-box .row {
        flex-direction: column;
    }
    
    .metric-box {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    
    .metric-box:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
}
</style>
{% endblock %}
{% block content %}

<!-- Project Header -->
<div class="project-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 mb-2">{{ project.name }}</h1>
                <p class="lead mb-3">
                    {% if project.end_date %}
                        Project completed • {{ project.start_date|date:"M d, Y" }} - {{ project.end_date|date:"M d, Y" }}
                    {% else %}
                        Active project • Started {{ project.start_date|date:"F d, Y" }}
                    {% endif %}
                </p>
                
                <div class="d-flex align-items-center gap-3">
                    <span class="status-badge {% if project.end_date %}status-completed{% else %}status-active{% endif %}">
                        <i class="fas {% if project.end_date %}fa-check-circle{% else %}fa-play{% endif %} me-1"></i>
                        {% if project.end_date %}Completed{% else %}Active{% endif %}
                    </span>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="summary-widget">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="fs-4 fw-bold">
                                {% widthratio total_payments total_billable 100 as completion_percent %}
                                {{ completion_percent|default:0 }}%
                            </div>
                            <small>Paid</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold">{{ job_entries|length }}</div>
                            <small>Entries</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold">${{ total_billable|floatformat:0|intcomma }}</div>
                            <small>Revenue</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Action Toolbar -->
    <div class="action-toolbar">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{% url 'dashboard:add_job_entry' project.pk %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Quick Entry
                    </a>
                    <a href="{% url 'dashboard:add_payment' project.pk %}" class="btn btn-success">
                        <i class="fas fa-money-bill-wave me-2"></i>Record Payment
                    </a>
                    <a href="{% url 'dashboard:customer_report' project.pk %}" class="btn btn-warning text-white">
                        <i class="fas fa-file-pdf me-2"></i>Customer Report
                    </a>
                    <a href="{% url 'dashboard:contractor_job_report' project.pk %}" class="btn btn-info text-white">
                        <i class="fas fa-hard-hat me-2"></i>Job Report
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-h me-2"></i>More Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit Project</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-copy me-2"></i>Duplicate</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-archive me-2"></i>Archive</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search entries..." id="search-entries">
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-number text-success">${{ total_billable|floatformat:2|intcomma }}</div>
                <div class="metric-label">Total Billable</div>
                <div class="metric-trend {% if total_billable > 0 %}text-success{% else %}text-muted{% endif %}">
                    <i class="fas fa-arrow-up me-1"></i>Project Revenue
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-number text-primary">${{ total_payments|floatformat:2|intcomma }}</div>
                <div class="metric-label">Payments Received</div>
                <div class="metric-trend {% if payments %}text-success{% else %}text-muted{% endif %}">
                    <i class="fas fa-credit-card me-1"></i>
                    {% if payments %}Last payment {{ payments.0.date|naturalday }}{% else %}No payments yet{% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-number {% if outstanding > 0 %}text-warning{% else %}text-success{% endif %}">${{ outstanding|floatformat:2|intcomma }}</div>
                <div class="metric-label">Outstanding</div>
                <div class="metric-trend {% if outstanding > 0 %}text-warning{% else %}text-success{% endif %}">
                    {% if outstanding > 0 %}
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% widthratio outstanding total_billable 100 as outstanding_percent %}
                        {{ outstanding_percent|floatformat:0 }}% of total
                    {% else %}
                        <i class="fas fa-check-circle me-1"></i>Fully paid
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="metric-number text-info">{{ job_entries|length }}</div>
                <div class="metric-label">Total Entries</div>
                <div class="metric-trend {% if job_entries %}text-success{% else %}text-muted{% endif %}">
                    {% if job_entries %}
                        <i class="fas fa-calendar me-1"></i>Last entry {{ job_entries.0.date|naturalday }}
                    {% else %}
                        <i class="fas fa-plus me-1"></i>No entries yet
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Payment Progress</h4>
            <span class="badge bg-success fs-6">
                {% widthratio total_payments total_billable 100 as payment_percent %}
                {{ payment_percent|default:0 }}% Paid
            </span>
        </div>
        <div class="progress-bar-custom">
            <div class="progress-fill" style="width: {{ payment_percent|default:0 }}%"></div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-dollar-sign me-1"></i>
                    Total revenue: ${{ total_billable|floatformat:2|intcomma }}
                </small>
            </div>
            <div class="col-md-6 text-md-end">
                <small class="text-muted">
                    <i class="fas fa-credit-card me-1"></i>
                    Collected: ${{ total_payments|floatformat:2|intcomma }}
                </small>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <ul class="nav nav-tabs nav-tabs-custom">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#entries-tab">
                <i class="fas fa-list me-2"></i>Job Entries ({{ job_entries|length }})
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payments-tab">
                <i class="fas fa-credit-card me-2"></i>Payments ({{ payments|length }})
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#timeline-tab">
                <i class="fas fa-history me-2"></i>Timeline
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analytics-tab">
                <i class="fas fa-chart-line me-2"></i>Analytics
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Job Entries Tab -->
        <div class="tab-pane fade show active" id="entries-tab">
            <div class="tab-content-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Job Entries</h5>
                    <div class="d-flex gap-2">
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="entry-filter" id="filter-all" checked>
                            <label class="btn btn-outline-secondary" for="filter-all">All</label>
                            
                            <input type="radio" class="btn-check" name="entry-filter" id="filter-labor">
                            <label class="btn btn-outline-secondary" for="filter-labor">Labor</label>
                            
                            <input type="radio" class="btn-check" name="entry-filter" id="filter-equipment">
                            <label class="btn btn-outline-secondary" for="filter-equipment">Equipment</label>
                            
                            <input type="radio" class="btn-check" name="entry-filter" id="filter-materials">
                            <label class="btn btn-outline-secondary" for="filter-materials">Materials</label>
                        </div>
                    </div>
                </div>

                <!-- Entry Rows -->
                {% for entry in job_entries %}
                <div class="entry-row{% if forloop.counter > 10 %} d-none{% endif %}" data-entry-type="{% if entry.employee %}labor{% elif entry.asset %}equipment{% elif entry.material_description %}materials{% else %}other{% endif %}">
                    <div class="d-flex align-items-center">
                        <div class="entry-type-icon {% if entry.employee %}entry-type-labor{% elif entry.asset %}entry-type-equipment{% elif entry.material_description %}entry-type-material{% else %}entry-type-equipment{% endif %}">
                            <i class="fas {% if entry.employee %}fa-hard-hat{% elif entry.asset %}fa-tools{% elif entry.material_description %}fa-boxes{% else %}fa-clipboard{% endif %}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        {% if entry.description %}
                                            {{ entry.description }}
                                        {% elif entry.material_description %}
                                            {{ entry.material_description }}
                                        {% else %}
                                            {% if entry.asset %}{{ entry.asset.name }} Usage{% endif %}
                                            {% if entry.employee %}{{ entry.employee.name }} Work{% endif %}
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">
                                        {{ entry.date|date:"M d, Y" }} • {{ entry.hours|floatformat:2 }} hours
                                        {% if entry.asset %} • {{ entry.asset.name }}{% endif %}
                                        {% if entry.employee %} • {{ entry.employee.name }}{% endif %}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="fs-5 fw-bold text-success">${{ entry.billable_amount|floatformat:2|intcomma }}</div>
                                    <small class="text-muted">Billable</small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    {% if entry.asset %}
                                        <span class="badge bg-primary">{{ entry.asset.name }}</span>
                                    {% endif %}
                                    {% if entry.employee %}
                                        <span class="badge bg-info">{{ entry.employee.name }}</span>
                                    {% endif %}
                                    {% if entry.material_description %}
                                        <span class="badge bg-secondary">Material</span>
                                    {% endif %}
                                    {% if entry.material_cost %}
                                        <span class="badge bg-warning text-dark">${{ entry.material_cost|floatformat:2 }} cost</span>
                                    {% endif %}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'dashboard:edit_job_entry' entry.pk %}" class="btn btn-outline-secondary" title="Edit Entry">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-outline-secondary" title="Duplicate Entry" onclick="duplicateEntry({{ entry.pk }})">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="Delete Entry" onclick="deleteEntry({{ entry.pk }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Job Entries</h5>
                    <p class="text-muted mb-3">No job entries have been recorded for this project yet.</p>
                    <a href="{% url 'dashboard:add_job_entry' project.pk %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add First Entry
                    </a>
                </div>
                {% endfor %}

                {% if job_entries|length > 10 %}
                <div class="text-center mt-4">
                    <button id="load-more-button" class="btn btn-outline-primary" onclick="loadMoreEntries()">
                        <i class="fas fa-chevron-down me-2"></i>Load More Entries
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Payments Tab -->
        <div class="tab-pane fade" id="payments-tab">
            <div class="tab-content-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">Payment History</h5>
                    <a href="{% url 'dashboard:add_payment' project.pk %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Record Payment
                    </a>
                </div>

                {% if payments %}
                <div class="table-responsive">
                    <table class="table materials-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for payment in payments %}
                            <tr>
                                <td>
                                    <strong>{{ payment.date|date:"M d, Y" }}</strong>
                                    <br><small class="text-muted">{{ payment.date|naturalday }}</small>
                                </td>
                                <td>
                                    <span class="fs-5 fw-bold text-success">${{ payment.amount|floatformat:2|intcomma }}</span>
                                </td>
                                <td>
                                    {% if payment.notes %}
                                        <span title="{{ payment.notes }}">
                                            {{ payment.notes|truncatechars:50 }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" title="Edit Payment" onclick="editPayment({{ payment.pk }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" title="Generate Receipt" onclick="generateReceipt({{ payment.pk }})">
                                            <i class="fas fa-receipt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td><strong>Total Payments</strong></td>
                                <td><strong class="fs-5 text-success">${{ total_payments|floatformat:2|intcomma }}</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Payments</h5>
                    <p class="text-muted mb-3">No payments have been recorded for this project yet.</p>
                    <a href="{% url 'dashboard:add_payment' project.pk %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Record First Payment
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Timeline Tab -->
        <div class="tab-pane fade" id="timeline-tab">
            <div class="timeline-card">
                <h5 class="mb-4">Project Timeline</h5>
                
                <!-- Combined timeline items -->
                {% for item in timeline_items %}
                <div class="timeline-item">
                    <div class="timeline-date">
                        <div class="fw-bold">{{ item.date|date:"M d" }}</div>
                        <div class="small">{{ item.date|date:"Y" }}</div>
                    </div>
                    <div class="timeline-content">
                        {% if item.entries %}
                            <h6>Job Entries Added ({{ item.entries|length }})</h6>
                            <p class="mb-2">
                                {% for entry in item.entries|slice:":3" %}
                                    {{ entry.description|default:"Work entry" }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                                {% if item.entries|length > 3 %}
                                    and {{ item.entries|length|add:"-3" }} more...
                                {% endif %}
                            </p>
                            <div class="d-flex gap-2">
                                <span class="badge bg-success">Work Completed</span>
                                {% if item.entries.0.asset %}<span class="badge bg-primary">Equipment</span>{% endif %}
                                {% if item.entries.0.employee %}<span class="badge bg-info">Labor</span>{% endif %}
                                {% if item.entries.0.material_description %}<span class="badge bg-secondary">Materials</span>{% endif %}
                            </div>
                        {% elif item.payments %}
                            <h6>Payment Received</h6>
                            <p class="mb-2">
                                Received ${{ item.payments.0.amount|floatformat:2|intcomma }}
                                {% if item.payments.0.notes %} - {{ item.payments.0.notes }}{% endif %}
                            </p>
                            <div class="d-flex gap-2">
                                <span class="badge bg-success">Payment</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Project start -->
                <div class="timeline-item">
                    <div class="timeline-date">
                        <div class="fw-bold">{{ project.start_date|date:"M d" }}</div>
                        <div class="small">{{ project.start_date|date:"Y" }}</div>
                    </div>
                    <div class="timeline-content">
                        <h6>Project Started</h6>
                        <p class="mb-2">{{ project.name }} project was created and work began.</p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-primary">Project Start</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Analytics Tab -->
        <div class="tab-pane fade" id="analytics-tab">
            <div class="tab-content-card">
                <div class="analytics-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1">Project Analytics</h5>
                            <p class="text-muted mb-0">Comprehensive business insights and profitability analysis</p>
                        </div>
                        <div class="col-md-4">
                            <div class="analytics-summary text-center">
                                <div class="d-flex justify-content-center align-items-center gap-3">
                                    <div class="text-center">
                                        <div class="h4 mb-0 text-success">${{ profit|floatformat:0|intcomma }}</div>
                                        <small class="text-muted">Total Profit</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="h4 mb-0 {% if margin >= 20 %}text-success{% elif margin >= 10 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ margin|floatformat:1 }}%
                                        </div>
                                        <small class="text-muted">Margin</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Performance Indicators -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card h-100">
                            <div class="kpi-icon bg-primary">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">${{ total_billable|floatformat:0|intcomma }}</div>
                                <div class="kpi-label">Total Revenue</div>
                                <div class="kpi-change text-success">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    {% if total_cost > 0 %}{% widthratio total_billable total_cost 100 as revenue_multiplier %}{{ revenue_multiplier|floatformat:0 }}% of costs{% else %}Revenue generated{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card h-100">
                            <div class="kpi-icon bg-warning">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">${{ total_cost|floatformat:0|intcomma }}</div>
                                <div class="kpi-label">Total Costs</div>
                                <div class="kpi-change text-info">
                                    <i class="fas fa-chart-pie me-1"></i>
                                    {% if total_billable > 0 %}{% widthratio total_cost total_billable 100 as cost_percentage %}{{ cost_percentage|floatformat:0 }}% of revenue{% else %}Project costs{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card h-100">
                            <div class="kpi-icon bg-success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ margin|floatformat:1 }}%</div>
                                <div class="kpi-label">Profit Margin</div>
                                <div class="kpi-change {% if margin >= 20 %}text-success{% elif margin >= 10 %}text-warning{% else %}text-danger{% endif %}">
                                    <i class="fas fa-{% if margin >= 20 %}thumbs-up{% elif margin >= 10 %}exclamation-triangle{% else %}exclamation-circle{% endif %} me-1"></i>
                                    {% if margin >= 20 %}Excellent{% elif margin >= 10 %}Good{% else %}Needs Improvement{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="kpi-card h-100">
                            <div class="kpi-icon bg-info">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="kpi-content">
                                <div class="kpi-value">{{ total_hours|floatformat:0 }}hrs</div>
                                <div class="kpi-label">Total Hours</div>
                                <div class="kpi-change text-primary">
                                    <i class="fas fa-calculator me-1"></i>
                                    {% if total_hours > 0 %}${{ avg_hourly_rate|floatformat:0 }}/hr avg{% else %}No hours logged{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Category Analysis -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="analytics-section-card">
                            <div class="section-header mb-4">
                                <h6 class="section-title">Category Performance Analysis</h6>
                                <p class="section-subtitle">Cost vs Revenue breakdown with profitability insights</p>
                            </div>

                            <!-- Labor Analysis -->
                            <div class="category-analysis-row mb-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="category-header">
                                            <div class="category-icon bg-primary">
                                                <i class="fas fa-hard-hat"></i>
                                            </div>
                                            <div class="category-info">
                                                <h6 class="category-name">Labor</h6>
                                                <p class="category-desc">Employee costs vs billing</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="category-metrics">
                                            <div class="row">
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-danger">${{ labor_cost|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Cost</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-success">${{ billable_labor|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Billed</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-primary">${{ labor_profit|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Profit</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        {% if labor_cost > 0 %}
                                                            {% widthratio billable_labor labor_cost 100 as labor_margin %}
                                                            <div class="metric-value {% if labor_margin >= 150 %}text-success{% elif labor_margin >= 120 %}text-warning{% else %}text-danger{% endif %}">{{ labor_margin|add:"-100"|floatformat:0 }}%</div>
                                                        {% else %}
                                                            <div class="metric-value text-muted">—</div>
                                                        {% endif %}
                                                        <div class="metric-label">Margin</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="progress-comparison mt-2">
                                            <div class="progress" style="height: 8px;">
                                                {% if billable_labor > 0 %}
                                                    <div class="progress-bar bg-danger" style="width: {{ labor_cost_percent|floatformat:0 }}%" title="Cost: {{ labor_cost_percent|floatformat:0 }}%"></div>
                                                    <div class="progress-bar bg-success" style="width: {{ labor_profit_percent|floatformat:0 }}%" title="Profit: {{ labor_profit_percent|floatformat:0 }}%"></div>
                                                {% endif %}
                                            </div>
                                                <div class="progress-labels d-flex justify-content-between mt-1">
                                                    <small class="text-muted">Cost vs Revenue comparison</small>
                                                    <small class="{% if labor_cost < billable_labor %}text-success{% else %}text-danger{% endif %}">
                                                        {% if labor_cost < billable_labor %}Profitable{% else %}Loss{% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Equipment Analysis -->
                            <div class="category-analysis-row mb-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="category-header">
                                            <div class="category-icon bg-warning">
                                                <i class="fas fa-tools"></i>
                                            </div>
                                            <div class="category-info">
                                                <h6 class="category-name">Equipment</h6>
                                                <p class="category-desc">Asset utilization & billing</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="category-metrics">
                                            <div class="row">
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-danger">${{ equipment_cost|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Cost</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-success">${{ billable_equipment|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Billed</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-primary">${{ equipment_profit|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Profit</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        {% if equipment_cost > 0 %}
                                                            {% widthratio billable_equipment equipment_cost 100 as equipment_margin %}
                                                            <div class="metric-value {% if equipment_margin >= 150 %}text-success{% elif equipment_margin >= 120 %}text-warning{% else %}text-danger{% endif %}">{{ equipment_margin|add:"-100"|floatformat:0 }}%</div>
                                                        {% else %}
                                                            <div class="metric-value text-muted">—</div>
                                                        {% endif %}
                                                        <div class="metric-label">Margin</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="progress-comparison mt-2">
                                            <div class="progress" style="height: 8px;">
                                                {% if billable_equipment > 0 %}
                                                    <div class="progress-bar bg-danger" style="width: {{ equip_cost_percent|floatformat:0 }}%" title="Cost: {{ equip_cost_percent|floatformat:0 }}%"></div>
                                                    <div class="progress-bar bg-success" style="width: {{ equip_profit_percent|floatformat:0 }}%" title="Profit: {{ equip_profit_percent|floatformat:0 }}%"></div>
                                                {% endif %}
                                            </div>
                                                <div class="progress-labels d-flex justify-content-between mt-1">
                                                    <small class="text-muted">Cost vs Revenue comparison</small>
                                                    <small class="{% if equipment_cost < billable_equipment %}text-success{% else %}text-danger{% endif %}">
                                                        {% if equipment_cost < billable_equipment %}Profitable{% else %}Loss{% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Materials Analysis -->
                            <div class="category-analysis-row mb-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="category-header">
                                            <div class="category-icon bg-secondary">
                                                <i class="fas fa-boxes"></i>
                                            </div>
                                            <div class="category-info">
                                                <h6 class="category-name">Materials</h6>
                                                <p class="category-desc">Material costs & markup</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="category-metrics">
                                            <div class="row">
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-danger">${{ material_cost|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Cost</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-success">${{ billable_material|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Billed</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        <div class="metric-value text-primary">${{ material_profit|floatformat:0|intcomma }}</div>
                                                        <div class="metric-label">Profit</div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="metric-box">
                                                        {% if material_cost > 0 %}
                                                            {% widthratio billable_material material_cost 100 as material_margin %}
                                                            <div class="metric-value {% if material_margin >= 125 %}text-success{% elif material_margin >= 110 %}text-warning{% else %}text-danger{% endif %}">{{ material_margin|add:"-100"|floatformat:0 }}%</div>
                                                        {% else %}
                                                            <div class="metric-value text-muted">—</div>
                                                        {% endif %}
                                                        <div class="metric-label">Markup</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="progress-comparison mt-2">
                                            <div class="progress" style="height: 8px;">
                                                {% if billable_material > 0 %}
                                                    <div class="progress-bar bg-danger" style="width: {{ mat_cost_percent|floatformat:0 }}%" title="Cost: {{ mat_cost_percent|floatformat:0 }}%"></div>
                                                    <div class="progress-bar bg-success" style="width: {{ mat_profit_percent|floatformat:0 }}%" title="Profit: {{ mat_profit_percent|floatformat:0 }}%"></div>
                                                {% endif %}
                                            </div>
                                                <div class="progress-labels d-flex justify-content-between mt-1">
                                                    <small class="text-muted">Cost vs Revenue comparison</small>
                                                    <small class="{% if material_cost < billable_material %}text-success{% else %}text-danger{% endif %}">
                                                        {% if material_cost < billable_material %}Profitable{% else %}Loss{% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Trends -->
                <div class="row">
                    <div class="col-12">
                        <div class="trends-card">
                            <div class="trends-header mb-3">
                                <h6 class="trends-title">
                                    <i class="fas fa-chart-area me-2 text-success"></i>
                                    Weekly Performance Trends
                                </h6>
                                <p class="trends-subtitle">Revenue and cost patterns over time</p>
                            </div>
                            
                            <div class="trends-chart">
                                <div class="row">
                                    {% for week_data in weekly_data %}
                                    <div class="col">
                                        <div class="week-column">
                                            <div class="week-bars">
                                                <div class="bar-container">
                                                    {% if week_data.billable > 0 %}
                                                        {% widthratio week_data.billable max_weekly_value 100 as bar_height %}
                                                        <div class="revenue-bar" style="height: {{ bar_height|floatformat:0 }}%;" title="Revenue: ${{ week_data.billable|floatformat:0 }}"></div>
                                                    {% endif %}
                                                    {% if week_data.cost > 0 %}
                                                        {% widthratio week_data.cost max_weekly_value 100 as cost_bar_height %}
                                                        <div class="cost-bar" style="height: {{ cost_bar_height|floatformat:0 }}%;" title="Cost: ${{ week_data.cost|floatformat:0 }}"></div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="week-label">
                                                <div class="week-name">{{ week_data.week }}</div>
                                                <div class="week-values">
                                                    <small class="text-success">${{ week_data.billable|floatformat:0 }}</small>
                                                    <small class="text-danger">${{ week_data.cost|floatformat:0 }}</small>
                                                </div>
                                                <div class="week-hours">{{ week_data.hours|floatformat:1 }}h</div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="chart-legend mt-3">
                                    <div class="d-flex justify-content-center gap-4">
                                        <div class="legend-item">
                                            <div class="legend-color revenue"></div>
                                            <span>Revenue</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color cost"></div>
                                            <span>Cost</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Business Insights & Recommendations -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="insights-card h-100">
                            <div class="insights-header">
                                <h6 class="insights-title">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    Business Insights
                                </h6>
                            </div>
                            <div class="insights-content">
                                <div class="insight-item">
                                    <div class="insight-icon">
                                        <i class="fas {% if margin >= 20 %}fa-trophy text-success{% elif margin >= 10 %}fa-thumbs-up text-warning{% else %}fa-exclamation-triangle text-danger{% endif %}"></i>
                                    </div>
                                    <div class="insight-text">
                                        <strong>Profitability:</strong>
                                        {% if margin >= 20 %}
                                            Excellent profit margin! Your pricing strategy is working well.
                                        {% elif margin >= 10 %}
                                            Good profit margin. Consider optimizing costs for better returns.
                                        {% else %}
                                            Low profit margin. Review pricing and cost management strategies.
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="insight-item">
                                    <div class="insight-icon">
                                        {% if labor_cost > equipment_cost and labor_cost > material_cost %}
                                            <i class="fas fa-users text-primary"></i>
                                        {% elif equipment_cost > labor_cost and equipment_cost > material_cost %}
                                            <i class="fas fa-cogs text-warning"></i>
                                        {% else %}
                                            <i class="fas fa-box text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <div class="insight-text">
                                        <strong>Cost Driver:</strong>
                                        {% if labor_cost > equipment_cost and labor_cost > material_cost %}
                                            Labor is your primary cost center ({{ labor_percent|floatformat:0 }}% of costs).
                                        {% elif equipment_cost > labor_cost and equipment_cost > material_cost %}
                                            Equipment costs dominate this project ({{ equipment_percent|floatformat:0 }}% of costs).
                                        {% else %}
                                            Materials represent the largest cost category ({{ material_percent|floatformat:0 }}% of costs).
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="insight-item">
                                    <div class="insight-icon">
                                        <i class="fas fa-chart-line text-info"></i>
                                    </div>
                                    <div class="insight-text">
                                        <strong>Efficiency:</strong>
                                        {% if total_hours > 0 %}
                                            Your average billing rate is ${{ avg_hourly_rate|floatformat:0 }}/hour across all categories.
                                        {% else %}
                                            No hours logged yet for efficiency calculation.
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="floating-actions">
    <a href="{% url 'dashboard:add_payment' project.pk %}" class="floating-btn success" title="Record Payment">
        <i class="fas fa-money-bill-wave"></i>
    </a>
    <a href="{% url 'dashboard:add_job_entry' project.pk %}" class="floating-btn primary" title="Add Job Entry">
        <i class="fas fa-plus"></i>
    </a>
    <a href="{% url 'dashboard:customer_report' project.pk %}" class="floating-btn warning" title="Generate Report">
        <i class="fas fa-file-pdf"></i>
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Entry filtering
    document.querySelectorAll('input[name="entry-filter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const filterType = this.id.replace('filter-', '');
            const entries = document.querySelectorAll('.entry-row');
            
            entries.forEach(entry => {
                if (filterType === 'all') {
                    entry.style.display = 'block';
                } else {
                    const entryType = entry.getAttribute('data-entry-type');
                    entry.style.display = entryType === filterType ? 'block' : 'none';
                }
            });
        });
    });

    // Search functionality
    document.getElementById('search-entries').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const entries = document.querySelectorAll('.entry-row');
        
        entries.forEach(entry => {
            const text = entry.textContent.toLowerCase();
            entry.style.display = text.includes(searchTerm) ? 'block' : 'none';
        });
    });

    // Progress bar animation
    function animateProgressBar() {
        const progressBar = document.querySelector('.progress-fill');
        if (progressBar) {
            const targetWidth = progressBar.style.width;
            progressBar.style.width = '0%';
            
            setTimeout(() => {
                progressBar.style.width = targetWidth;
            }, 500);
        }
    }

    // Animate on page load
    animateProgressBar();

    // Tab switching with URL hash
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const tabId = e.target.getAttribute('data-bs-target').substring(1);
            window.location.hash = tabId;
        });
    });

    // Load tab from URL hash
    if (window.location.hash) {
        const tab = document.querySelector(`[data-bs-target="${window.location.hash}"]`);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'n':
                    e.preventDefault();
                    window.location.href = '{% url "dashboard:add_job_entry" project.pk %}';
                    break;
                case 'p':
                    e.preventDefault();
                    window.location.href = '{% url "dashboard:add_payment" project.pk %}';
                    break;
                case 'r':
                    e.preventDefault();
                    window.location.href = '{% url "dashboard:customer_report" project.pk %}';
                    break;
            }
        }
    });
});

// Entry management functions
function duplicateEntry(entryId) {
    if (confirm('Create a duplicate of this entry?')) {
        // Would implement AJAX call to duplicate entry
        console.log('Duplicating entry:', entryId);
        // Reload page for now
        location.reload();
    }
}

function deleteEntry(entryId) {
    if (confirm('Are you sure you want to delete this entry? This action cannot be undone.')) {
        // Would implement AJAX call to delete entry
        console.log('Deleting entry:', entryId);
        // Reload page for now
        location.reload();
    }
}

function editPayment(paymentId) {
    console.log('Editing payment:', paymentId);
    // Would open modal or navigate to edit page
}

function generateReceipt(paymentId) {
    console.log('Generating receipt for payment:', paymentId);
    // Would generate and download receipt
}

function loadMoreEntries() {
    const hiddenEntries = document.querySelectorAll('.entry-row.d-none');
    for (let i = 0; i < 10 && i < hiddenEntries.length; i++) {
        hiddenEntries[i].classList.remove('d-none');
    }
    if (document.querySelectorAll('.entry-row.d-none').length === 0) {
        const btn = document.getElementById('load-more-button');
        if (btn) {
            btn.classList.add('d-none');
        }
    }
}
</script>

{% endblock %}
