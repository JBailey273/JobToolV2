{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Contractor Job Report{% endblock %}
{% block content %}
<div class="text-center mb-3">
  {% if contractor_logo_url %}
  <img src="{{ contractor_logo_url }}" alt="Contractor logo thumbnail" style="height:60px;" />
  {% endif %}
  <h2>{{ contractor.name|default:contractor.email }}</h2>
</div>
<h1 class="text-center">Contractor Job Report - {{ project.name }}</h1>
{% if not report %}
<a href="?export=pdf" class="btn btn-secondary mb-3 d-print-none">Download PDF</a>
{% endif %}
<div {% if not report %}class="table-responsive"{% endif %}>
    <table class="table table-bordered" style="width:100%; table-layout:fixed;">
        <colgroup>
            <col style="width:10%">
            <col style="width:20%">
            <col style="width:12%">
            <col style="width:12%">
            <col style="width:12%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:8%">
            <col style="width:5%">
            <col style="width:5%">
        </colgroup>
        <thead class="table-light">
            <tr>
                <th style="text-align:left;">Date</th>
                <th style="text-align:left;">Description</th>
                <th style="text-align:left;">Asset</th>
                <th style="text-align:left;">Employee</th>
                <th style="text-align:left;">Material</th>
                <th style="text-align:right;">Hours / Qty</th>
                <th style="text-align:right;">Actual Cost</th>
                <th style="text-align:right;">Billable Amount</th>
                <th style="text-align:right;">Profit</th>
                <th style="text-align:right;">Margin</th>
            </tr>
        </thead>
        <tbody>
        {% for e in entries %}
            <tr>
                <td style="text-align:left;">{{ e.date }}</td>
                <td style="text-align:left; word-wrap:break-word;">{{ e.description }}</td>
                <td style="text-align:left; word-wrap:break-word;">{% if e.asset %}{{ e.asset.name }}{% endif %}</td>
                <td style="text-align:left; word-wrap:break-word;">{% if e.employee %}{{ e.employee.name }}{% endif %}</td>
                <td style="text-align:left; word-wrap:break-word;">{{ e.material_description }}</td>
                <td style="text-align:right;">{{ e.hours }}</td>
                <td style="text-align:right;">${{ e.cost_amount }}</td>
                <td style="text-align:right;">${{ e.billable_amount }}</td>
                <td style="text-align:right;">${{ e.profit }}</td>
                <td style="text-align:right;">{{ e.margin|floatformat:2 }}%</td>
            </tr>
        {% empty %}
            <tr><td colspan="{{ total_columns }}">No job entries.</td></tr>
        {% endfor %}
        <tr>
            <td colspan="{{ colspan_before_total }}" style="text-align:right; font-weight:bold;">Totals</td>
            <td style="text-align:right; font-weight:bold;">${{ total_cost }}</td>
            <td style="text-align:right; font-weight:bold;">${{ total_billable }}</td>
            <td style="text-align:right; font-weight:bold;">${{ total_profit }}</td>
            <td style="text-align:right; font-weight:bold;">{{ overall_margin|floatformat:2 }}%</td>
        </tr>
        </tbody>
    </table>
</div>

{% if payments %}
<h2>Payments</h2>
<div {% if not report %}class="table-responsive"{% endif %}>
    <table class="table table-bordered" style="width:100%; table-layout:fixed;">
        <colgroup>
            <col style="width:50%">
            <col style="width:50%">
        </colgroup>
        <thead class="table-light">
            <tr>
                <th style="text-align:left;">Date</th>
                <th style="text-align:right;">Amount</th>
            </tr>
        </thead>
        <tbody>
        {% for p in payments %}
            <tr>
                <td style="text-align:left;">{{ p.date }}</td>
                <td style="text-align:right;">${{ p.amount }}</td>
            </tr>
        {% endfor %}
        <tr>
            <td style="text-align:right; font-weight:bold;">Total Payments</td>
            <td style="text-align:right; font-weight:bold;">${{ total_payments }}</td>
        </tr>
        </tbody>
    </table>
</div>
{% else %}
<p>No payments have been recorded.</p>
{% endif %}

<p><strong>Outstanding Balance: ${{ outstanding }}</strong></p>
{% endblock %}
